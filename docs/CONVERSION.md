# Book Conversion Workflow

This document describes the book generation and conversion process.

## Overview

The Terran Society Book can be generated in multiple formats:
1. **Markdown (MD)** - Source format with structured data
2. **OpenDocument Text (ODT)** - LibreOffice/OpenOffice format
3. **PDF** - Portable Document Format for distribution

## Conversion Pipeline

### Step 1: Generate Markdown
```bash
python3 scripts/generate_book.py
```
- Queries PostgreSQL database (`db_terran_society.scm_terran_society`)
- Loads book metadata (title, authors, version, dedication)
- Generates front matter (title page, authors, dedication, TOC placeholder)
- Generates book chapters from database content
- Outputs: `book/manuscript.md`

### Step 2: Convert to ODT
```bash
pandoc book/manuscript.md -o book/TerranSocietyBook.odt --toc --toc-depth=3
```
- Uses Pandoc to convert Markdown to ODT format
- Generates table of contents with 3 levels of depth
- Outputs: `book/TerranSocietyBook.odt`
- Can be opened and edited in LibreOffice Writer

### Step 3: Convert to PDF

#### Option A: From ODT (Recommended)
```bash
libreoffice --headless --convert-to pdf --outdir book/ book/TerranSocietyBook.odt
```
- Uses LibreOffice in headless mode
- Preserves formatting from ODT
- Outputs: `book/TerranSocietyBook.pdf`
- **Advantage**: Maintains complex formatting and styles

#### Option B: Direct from Markdown (Requires XeLaTeX)
```bash
pandoc book/manuscript.md -o book/TerranSocietyBook.pdf \
  --pdf-engine=xelatex --toc --toc-depth=3 \
  -V geometry:margin=1in \
  -V fontsize=11pt \
  -V documentclass=book
```
- Requires `texlive-xetex` package installed
- Direct conversion without ODT intermediate
- More control over LaTeX formatting
- **Advantage**: Consistent typography, better for print

## Web Interface

The Flask web application provides buttons on the Dashboard (Book Status card):

1. **Regenerate Book (MD)** - Runs `generate_book.py` to create manuscript.md
2. **Convert to ODT** - Converts MD to ODT using Pandoc
3. **Convert to PDF** - Dropdown menu with two options:
   - **From ODT (LibreOffice)** - Recommended for most users
   - **From MD (XeLaTeX)** - Requires XeLaTeX installation

## File Locations

- **Source**: `book/manuscript.md`
- **OpenDocument**: `book/TerranSocietyBook.odt`
- **PDF**: `book/TerranSocietyBook.pdf`

## Front Matter

The generated book includes:
- **Title Page**: Book title, subtitle, version, date (YAML metadata for headers/footers)
- **Authors Page**: List of authors with roles and version information
- **Dedication**: Quote from Lao Tzu by default (editable in database)
- **Table of Contents**: Auto-generated by Pandoc with 3-level depth

## Headers and Footers

Configured via database (`scm_terran_society.book_metadata`):
- **Odd pages header**: "Terran Society: A New Social Contract    {chapter_title}"
- **Even pages header**: "{section_title}    Terran Society"
- **Footer (all pages)**: "{page_number}    Draft v{version} â€“ {date}"

## System Requirements

### Required
- Python 3.x with psycopg2
- Pandoc
- LibreOffice (for PDF conversion)

### Optional
- XeLaTeX (texlive-xetex) - for direct MD to PDF conversion

### Installation (Ubuntu/Debian)
```bash
# Required packages
sudo apt-get install pandoc libreoffice

# Optional (for XeLaTeX)
sudo apt-get install texlive-xetex texlive-fonts-recommended texlive-fonts-extra
```

## Troubleshooting

### "Manuscript file not found"
- Run "Regenerate Book (MD)" first to create manuscript.md

### "ODT file not found"
- Run "Convert to ODT" before attempting PDF conversion from ODT

### "Pandoc not found"
- Install pandoc: `sudo apt-get install pandoc`

### "LibreOffice conversion failed"
- Ensure LibreOffice is installed: `which libreoffice`
- Check file permissions in `book/` directory

### Headers/footers not appearing in ODT
- Pandoc's ODT output may not fully support custom headers/footers
- Open in LibreOffice Writer and manually configure under Format > Page Style

## Editing Workflow

1. **Update database** - Modify tiers, branches, institutions, roles, duties via web interface
2. **Edit metadata** - Update title, authors, version via `/book/metadata` route
3. **Regenerate** - Click "Regenerate Book (MD)" to reflect changes
4. **Convert** - Convert to ODT and/or PDF for distribution
5. **Review** - Open ODT in LibreOffice for final formatting adjustments
