# Page Breaks and Table of Contents Implementation

## Overview
This document explains how page breaks and table of contents are implemented in the book generation pipeline.

## Problem
HTML/CSS page breaks (`<div style='page-break-after: always;'></div>`) do not reliably work when converting Markdown to ODT format using Pandoc. This was causing page breaks to not appear in the generated ODT and PDF files.

## Solution

### 1. Lua Filter for Page Breaks
Created `scripts/pagebreak.lua` - a Pandoc Lua filter that converts HTML div elements with page-break styles into native ODT page break elements.

The filter:
- Detects `<div>` elements with `page-break-after` or `page-break-before` styles
- Converts them to ODT-native page break paragraphs: `<text:p text:style-name="Pagebreak"/>`

### 2. Reference ODT Document
Created `book/reference.odt` with:
- A "Pagebreak" paragraph style that includes `fo:break-after="page"` property
- Basic page layout and footer with page numbers
- Style definitions that Pandoc uses as a template when generating ODT output

### 3. Updated Conversion Command
The ODT conversion now uses:
```bash
pandoc manuscript.md -o TerranSocietyBook.odt \
  --toc \
  --toc-depth=3 \
  --standalone \
  --lua-filter scripts/pagebreak.lua \
  --reference-doc book/reference.odt
```

## Page Break Locations
The manuscript includes page breaks at:
1. After cover page (Title)
2. After blank page
3. After author/version page
4. After dedication page
5. After table of contents
6. Before "Basic Principles of Terran Society"
7. Before each major section (Rights, Organizational Structure, District Level, Regional branches, World Level, Processes, Glossary)

## Table of Contents
The TOC is automatically generated by Pandoc using the `--toc` flag. It:
- Includes headings up to level 3 (controlled by `--toc-depth=3`)
- Appears after the dedication page
- Is generated as a native ODT table-of-content element

## Headers and Footers
The reference ODT now includes properly configured headers and footers:
- **Header**: "Terran Society: A New Social Contract"
- **Footer**: Page number — Draft v1.0 — 2025

To modify headers/footers:
1. Edit `scripts/add_headers_footers.py` to change header/footer text
2. Run: `python3 scripts/add_headers_footers.py`
3. Or manually edit `book/reference.odt` in LibreOffice:
   - Format → Styles → Manage Styles
   - Select "Standard" page style → Modify
   - Configure headers/footers in the "Header" and "Footer" tabs

## Cover and Author Pages
The book now includes properly formatted front matter:
- **Cover page**: Centered vertically and horizontally with title and subtitle
- **Blank page**: Full blank page
- **Author page**: Centered with title, author name, version, and copyright
- All front matter pages use Pandoc fenced divs for proper centering

## Verification
To verify page breaks are working:
```bash
# Generate manuscript
python3 scripts/generate_book.py

# Convert to ODT
cd book
pandoc manuscript.md -o TerranSocietyBook.odt --toc --toc-depth=3 --standalone --lua-filter ../scripts/pagebreak.lua --reference-doc reference.odt

# Check for page breaks in ODT
unzip -q TerranSocietyBook.odt -d temp
grep -c "Pagebreak" temp/content.xml  # Should show ~17 page breaks
rm -rf temp

# Convert to PDF
libreoffice --headless --convert-to pdf TerranSocietyBook.odt

# Open PDF and verify page breaks and TOC visually
```

## Web Interface
The web application automatically applies these fixes when:
- "Convert to ODT" button is clicked
- "Convert to PDF" button is clicked (after ODT conversion)

## Troubleshooting

### Page breaks not appearing
1. Verify `scripts/pagebreak.lua` exists
2. Verify `book/reference.odt` exists and contains Pagebreak style
3. Check Pandoc version (tested with Pandoc 2.x)

### TOC not appearing
1. Verify `--toc` flag is present in pandoc command
2. Check that manuscript has proper heading levels (# ## ###)
3. ODT may require opening in LibreOffice and updating fields (F9)

### Headers/Footers not as expected
1. Modify `book/reference.odt` in LibreOffice
2. Configure desired header/footer layout
3. Save and regenerate the book
